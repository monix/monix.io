<!DOCTYPE html>
<html lang="en-us">

  <head>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  
  
  <title>Circuit Breaker &mdash; Monix</title>

  <!-- Twitter Cards -->
  
  <meta name="twitter:card" content="summary">
  <meta name="twitter:image:src" content="https://monix.io/public/images/monix-logo-rect.png">
  <meta name="twitter:site" content="@monix" />  
  <meta name="twitter:creator" content="@monix" />  
  <meta name="twitter:title" content="Circuit Breaker &amp;mdash; Monix" />
  <meta name="twitter:description" content="A data type for providing stability and prevent cascading failures in distributed systems." />
  <meta name="twitter:url" content="https://monix.io/docs/3x/catnap/circuit-breaker">
  <!-- Facebook Open-Graph -->
  <meta property="fb:app_id" content="2160100887367418" />

  <meta content="Monix" property="og:site_name">
  <meta content="Circuit Breaker &amp;mdash; Monix" property="og:title">
  <meta content="A data type for providing stability and prevent cascading failures in distributed systems." property="og:description">
  <meta content="https://monix.io/docs/3x/catnap/circuit-breaker" property="og:url">
    
  <meta content="article" property="og:type">
  <meta property="og:image" content="https://monix.io/public/images/monix-logo.png" />
  <meta property="og:image:secure_url" content="https://monix.io/public/images/monix-logo.png" />
  <!-- Javascript -->
  <script src="//code.jquery.com/jquery-2.2.4.min.js" type="text/javascript" language="javascript"></script>
  <script src="/public/js/toc.js?1587577990104511557" type="text/javascript" language="javascript"></script>
  <script src="/public/js/init.js?1587577990104511557" type="text/javascript" language="javascript"></script>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/all.css?1587577990104511557">
  <!--[if lt IE 9]>
  <link rel="stylesheet" href="/public/css/forkme.ie.css?1587577990104511557">
  <![endif]-->

  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  <!-- Web App Manifest, see: http://manifest.sysapps.org/ -->
  <link rel="manifest" href="/manifest.json">
  <!-- Icons -->
  <link rel="icon" sizes="48x48" href="/public/icons/icon-48x48.png">
  <link rel="icon" sizes="72x72" href="/public/icons/icon-72x72.png">
  <link rel="icon" sizes="96x96" href="/public/icons/icon-96x96.png">
  <link rel="icon" sizes="144x144" href="/public/icons/icon-144x144.png">
  <link rel="icon" sizes="192x192" href="/public/icons/icon-192x192.png">
  <link rel="icon" sizes="240x240" href="/public/icons/icon-240x240.png">
  <link rel="icon" sizes="384x384" href="/public/icons/icon-384x384.png">
  <!-- Mobile Safari / iOS Icons -->
  <link rel="apple-touch-icon" sizes="48x48" href="/public/icons/icon-48x48.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/public/icons/icon-72x72.png">
  <link rel="apple-touch-icon" sizes="96x96" href="/public/icons/icon-96x96.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/public/icons/icon-144x144.png">
  <link rel="apple-touch-icon" sizes="192x192" href="/public/icons/icon-192x192.png">
  <link rel="apple-touch-icon" sizes="240x240" href="/public/icons/icon-240x240.png">
  <link rel="apple-touch-icon" sizes="384x384" href="/public/icons/icon-384x384.png">
  <!-- Standard Favicon -->
  <link rel="shortcut icon" href="/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/atom+xml" title="Feed" href="/blog/atom.xml">
</head>


  <body class="monix layout">
    <div class="wrapper">
      <aside class="sidebar plus">
  <div class="container">
    <div class="sidebar-about">
      <a class="github-fork-ribbon left-top" href="https://github.com/monix/monix"
        title="Fork me on GitHub">Fork me on GitHub</a>

      <h1>
        <a href="/">
          <img src="/public/images/monix-logo.png"
            alt="Monix Logo" title="Monix" class="logo" />
        </a>
      </h1>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item" href="/">About</a>
      <a class="sidebar-nav-item" href="/blog/">Blog</a>
      <a class="sidebar-nav-item active" href="/docs/3x/">Documentation</a>
      <a class="sidebar-nav-item" href="/presentations/">Presentations</a>
      <a class="sidebar-nav-item" href="/social.html">Follow @Monix</a>
      <a class="sidebar-nav-item" href="/privacy.html">Privacy Policy</a>
    </nav>
  </div>
</aside>


      <article class="content container">
        <div class="page">
  <h1 class="page-title">Circuit Breaker</h1>
  <nav role="navigation" id="type-info">
    <a href="/api/3.1/monix/catnap/CircuitBreaker.html">API Documentation</a>
    <a href="https://github.com/monix/monix/blob/v3.1.0/monix-catnap/shared/src/main/scala/monix/catnap/CircuitBreaker.scala">Source Code</a>
    
    <a href="https://github.com/monix/monix.io/edit/master/_tut/docs/3x/catnap/circuit-breaker.md">Edit Page</a>
  </nav>

  <nav role="navigation" id="toc"></nav>

  <p>The <code class="highlighter-rouge">CircuitBreaker</code> is used to provide stability and prevent
cascading failures in distributed systems.</p>

<h2 id="purpose">Purpose</h2>

<p>As an example, we have a web application interacting with a remote
third party web service. Letâ€™s say the third party has oversold their
capacity and their database melts down under load. Assume that the
database fails in such a way that it takes a very long time to hand
back an error to the third party web service. This in turn makes calls
fail after a long period of time. Back to our web application, the
users have noticed that their form submissions take much longer
seeming to hang. Well the users do what they know to do which is use
the refresh button, adding more requests to their already running
requests. This eventually causes the failure of the web application
due to resource exhaustion. This will affect all users, even those who
are not using functionality dependent on this third party web service.</p>

<p>Introducing circuit breakers on the web service call would cause the
requests to begin to fail-fast, letting the user know that something
is wrong and that they need not refresh their request. This also
confines the failure behavior to only those users that are using
functionality dependent on the third party, other users are no longer
affected as there is no resource exhaustion. Circuit breakers can also
allow savvy developers to mark portions of the site that use the
functionality unavailable, or perhaps show some cached content as
appropriate while the breaker is open.</p>

<h2 id="how-it-works">How it Works</h2>

<p>The circuit breaker models a concurrent state machine that can be in
any of these 3 states:</p>

<ol>
  <li><code class="highlighter-rouge">Closed</code>: During normal operations or when the <code class="highlighter-rouge">CircuitBreaker</code> starts
    <ul>
      <li>Exceptions increment the <code class="highlighter-rouge">failures</code> counter</li>
      <li>Successes reset the <code class="highlighter-rouge">failures</code> counter to zero</li>
      <li>When the <code class="highlighter-rouge">failures</code> counter reaches the <code class="highlighter-rouge">maxFailures</code> threshold,
 the breaker is tripped into the <code class="highlighter-rouge">Open</code> state</li>
    </ul>
  </li>
  <li><code class="highlighter-rouge">Open</code>: The circuit breaker rejects all tasks
    <ul>
      <li>all tasks fail fast with <code class="highlighter-rouge">ExecutionRejectedException</code></li>
      <li>after the configured <code class="highlighter-rouge">resetTimeout</code>, the circuit breaker enters a
 <code class="highlighter-rouge">HalfOpen</code> state, allowing one task to go through for testing the
 connection</li>
    </ul>
  </li>
  <li><code class="highlighter-rouge">HalfOpen</code>: The circuit breaker has already allowed a task to go
through, as a reset attempt, in order to test the connection
    <ul>
      <li>The first task when <code class="highlighter-rouge">Open</code> has expired is allowed through without
 failing fast, just before the circuit breaker is evolved into the
 <code class="highlighter-rouge">HalfOpen</code> state</li>
      <li>All tasks attempted in <code class="highlighter-rouge">HalfOpen</code> fail-fast with an exception just
 as in the <code class="highlighter-rouge">Open</code> state</li>
      <li>If that task attempt succeeds, the breaker is reset back to the
 <code class="highlighter-rouge">Closed</code> state, with the <code class="highlighter-rouge">resetTimeout</code> and the <code class="highlighter-rouge">failures</code> count
 also reset to initial values</li>
      <li>If the task attempt fails, the breaker is tripped again into the
 <code class="highlighter-rouge">Open</code> state (the <code class="highlighter-rouge">resetTimeout</code> is multiplied by the exponential
 backoff factor, up to the configured <code class="highlighter-rouge">maxResetTimeout</code>)</li>
    </ul>
  </li>
</ol>

<p><img src="/public/images/circuit-breaker-states.png" align="center" style="max-width: 100%" />
(image credits go to Akkaâ€™s documentation)</p>

<h2 id="usage">Usage</h2>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">monix.catnap.CircuitBreaker</span>
<span class="k">import</span> <span class="nn">monix.eval._</span>
<span class="k">import</span> <span class="nn">scala.concurrent.duration._</span>

<span class="k">val</span> <span class="nv">circuitBreaker</span><span class="k">:</span> <span class="kt">Task</span><span class="o">[</span><span class="kt">CircuitBreaker</span><span class="o">[</span><span class="kt">Task</span><span class="o">]]</span> <span class="k">=</span> 
  <span class="nc">CircuitBreaker</span><span class="o">[</span><span class="kt">Task</span><span class="o">].</span><span class="py">of</span><span class="o">(</span>
    <span class="n">maxFailures</span> <span class="k">=</span> <span class="mi">5</span><span class="o">,</span>
    <span class="n">resetTimeout</span> <span class="k">=</span> <span class="mf">10.</span><span class="n">seconds</span>
  <span class="o">)</span>
</code></pre></div></div>

<p>Note the builderâ€™s returned reference is given in the <code class="highlighter-rouge">Task</code> context,
because <code class="highlighter-rouge">CircuitBreaker</code> has shared state and doing otherwise
would violate in some cases referential transparency.</p>

<p>You can workaround it by using the <code class="highlighter-rouge">unsafe</code> builder, but only do this
if you know what youâ€™re doing, otherwise prefer the safe alternative:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">CircuitBreaker</span><span class="o">[</span><span class="kt">Task</span><span class="o">].</span><span class="py">unsafe</span><span class="o">(</span>
  <span class="n">maxFailures</span> <span class="k">=</span> <span class="mi">5</span><span class="o">,</span>
  <span class="n">resetTimeout</span> <span class="k">=</span> <span class="mf">10.</span><span class="n">seconds</span>
<span class="o">)</span>
</code></pre></div></div>

<p>And in order to protect tasks being processed, one can use <code class="highlighter-rouge">protect</code>:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">problematic</span> <span class="k">=</span> <span class="nc">Task</span> <span class="o">{</span>
  <span class="k">val</span> <span class="nv">nr</span> <span class="k">=</span> <span class="nv">util</span><span class="o">.</span><span class="py">Random</span><span class="o">.</span><span class="py">nextInt</span><span class="o">()</span>
  <span class="nf">if</span> <span class="o">(</span><span class="n">nr</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="n">nr</span> <span class="k">else</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nc">RuntimeException</span><span class="o">(</span><span class="s">"dummy"</span><span class="o">)</span>
<span class="o">}</span>

<span class="k">for</span> <span class="o">{</span>
  <span class="n">ci</span> <span class="k">&lt;-</span> <span class="n">circuitBreaker</span>
  <span class="n">r</span>  <span class="k">&lt;-</span> <span class="nv">ci</span><span class="o">.</span><span class="py">protect</span><span class="o">(</span><span class="n">problematic</span><span class="o">)</span>
<span class="o">}</span> <span class="k">yield</span> <span class="n">r</span>
</code></pre></div></div>

<p>When attempting to close the circuit breaker and resume normal
operations, we can also apply an exponential backoff for repeated
failed attempts, like so:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">circuitBreaker</span> <span class="k">=</span> <span class="nc">CircuitBreaker</span><span class="o">[</span><span class="kt">Task</span><span class="o">].</span><span class="py">of</span><span class="o">(</span>
  <span class="n">maxFailures</span> <span class="k">=</span> <span class="mi">5</span><span class="o">,</span>
  <span class="n">resetTimeout</span> <span class="k">=</span> <span class="mf">10.</span><span class="n">seconds</span><span class="o">,</span>
  <span class="n">exponentialBackoffFactor</span> <span class="k">=</span> <span class="mi">2</span><span class="o">,</span>
  <span class="n">maxResetTimeout</span> <span class="k">=</span> <span class="mf">10.</span><span class="n">minutes</span>
<span class="o">)</span>
</code></pre></div></div>

<p>In this sample we attempt to reconnect after 10 seconds, then after
20, 40 and so on, a delay that keeps increasing up to a configurable
maximum of 10 minutes.</p>

<h3 id="event-handlers">Event Handlers</h3>

<p>In case you want to trigger events when the Circuit Breaker changes
its state, like logging or metrics-related:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">CircuitBreaker</span><span class="o">[</span><span class="kt">Task</span><span class="o">].</span><span class="py">of</span><span class="o">(</span>
  <span class="n">maxFailures</span> <span class="k">=</span> <span class="mi">5</span><span class="o">,</span>
  <span class="n">resetTimeout</span> <span class="k">=</span> <span class="mf">10.</span><span class="n">seconds</span><span class="o">,</span>
  
  <span class="n">onRejected</span> <span class="k">=</span> <span class="nc">Task</span> <span class="o">{</span> 
    <span class="nf">println</span><span class="o">(</span><span class="s">"Task rejected in Open or HalfOpen"</span><span class="o">)</span>
  <span class="o">},</span>
  <span class="n">onClosed</span> <span class="k">=</span> <span class="nc">Task</span> <span class="o">{</span>
    <span class="nf">println</span><span class="o">(</span><span class="s">"Switched to Close, accepting tasks again"</span><span class="o">)</span>
  <span class="o">},</span>
  <span class="n">onHalfOpen</span> <span class="k">=</span> <span class="nc">Task</span> <span class="o">{</span>
    <span class="nf">println</span><span class="o">(</span><span class="s">"Switched to HalfOpen, accepted one task for testing"</span><span class="o">)</span>
  <span class="o">},</span>
  <span class="n">onOpen</span> <span class="k">=</span> <span class="nc">Task</span> <span class="o">{</span>
    <span class="nf">println</span><span class="o">(</span><span class="s">"Switched to Open, all incoming tasks rejected for the next 10 seconds"</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">)</span>
</code></pre></div></div>

<h3 id="retrying-after-close">Retrying after Close</h3>

<p>In case a retry strategy needs to be implemented, the naive way of
handling it would be to retry with a delay:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">val</span> <span class="nv">task</span> <span class="k">=</span> <span class="nv">circuitBreaker</span><span class="o">.</span><span class="py">protect</span><span class="o">(</span><span class="n">problematic</span><span class="o">)</span>

<span class="nv">task</span><span class="o">.</span><span class="py">onErrorRestartLoop</span><span class="o">(</span><span class="mf">100.</span><span class="n">millis</span><span class="o">)</span> <span class="o">{</span> <span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="n">delay</span><span class="o">,</span> <span class="n">retry</span><span class="o">)</span> <span class="k">=&gt;</span>
  <span class="c1">// Exponential back-off, but with a limit</span>
  <span class="nf">if</span> <span class="o">(</span><span class="n">delay</span> <span class="o">&lt;</span> <span class="mf">4.</span><span class="n">seconds</span><span class="o">)</span>
    <span class="nf">retry</span><span class="o">(</span><span class="n">delay</span> <span class="o">*</span> <span class="mi">2</span><span class="o">).</span><span class="py">delayExecution</span><span class="o">(</span><span class="n">delay</span><span class="o">)</span>
  <span class="k">else</span>
    <span class="nv">Task</span><span class="o">.</span><span class="py">raiseError</span><span class="o">(</span><span class="n">e</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div></div>

<p>But on the other hand you can wait for the precise moment the
<code class="highlighter-rouge">CircuitBreaker</code> closes again:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">task</span><span class="o">.</span><span class="py">onErrorRestartLoop</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span> <span class="o">{</span> <span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="n">times</span><span class="o">,</span> <span class="n">retry</span><span class="o">)</span> <span class="k">=&gt;</span>
  <span class="c1">// Retrying for a maximum of 10 times</span>
  <span class="nf">if</span> <span class="o">(</span><span class="n">times</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">)</span>
    <span class="nv">circuitBreaker</span><span class="o">.</span><span class="py">awaitClose</span><span class="o">.</span><span class="py">flatMap</span><span class="o">(</span><span class="k">_</span> <span class="k">=&gt;</span> <span class="nf">retry</span><span class="o">(</span><span class="n">times</span> <span class="o">+</span> <span class="mi">1</span><span class="o">))</span>
  <span class="k">else</span>
    <span class="nv">Task</span><span class="o">.</span><span class="py">raiseError</span><span class="o">(</span><span class="n">e</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="credits">Credits</h2>

<div class="extra">
  <p>This data type was inspired by the availability of
<a href="http://doc.akka.io/docs/akka/current/common/circuitbreaker.html">Akkaâ€™s Circuit Breaker</a>.
The implementation and the API are not the same, but the
purpose and the state machine it uses is similar.</p>

  <p>This documentation also has copy/pasted fragments from Akka.
Credit should be given where credit is due ðŸ˜‰</p>
</div>


  <div id="version3x">
    You are viewing the documentation for the latest Monix 3.x series.<br/>
    If you're looking for the older 2.x
    <a href="/docs/2x/">click here</a>!
  </div>

  <div class="buttons">
    <a href="/docs/3x/">Contents</a> â€¢
    <a href="https://github.com/monix/monix.io/edit/master/_tut/docs/3x/catnap/circuit-breaker.md">
      Edit Page</a> â€¢
    
    <a href="https://gitter.im/monix/monix">
      Join Chat</a> â€¢
    <a href="/social.html">
      Follow</a>
  </div>
</div>

      </article>
    </div>
    
<script type="text/javascript">window.siteGaID = 'UA-84530423-2';</script>
<script async src="/public/js/ga.js?1587577990104511557" type="text/javascript" language="javascript"></script>



  </body>
</html>
